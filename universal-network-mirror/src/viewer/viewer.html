<!DOCTYPE html>
<html>
<head>
    <title>Universal Network Mirror</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; color: #00ffcc; font-family: monospace; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 10; }
        .hud-item { margin-bottom: 5px; text-shadow: 0 0 5px #00ffcc; }
        
        #inspector {
            position: absolute; top: 10px; right: 10px; width: 300px;
            background: rgba(0, 10, 20, 0.9); border: 1px solid #00ffcc;
            padding: 15px; display: none; font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
            backdrop-filter: blur(5px); pointer-events: auto;
            max-height: 80vh; overflow-y: auto;
        }
        #inspector.minimized { height: 30px; overflow: hidden; }
        
        #topic-inspector {
            position: absolute; top: 60px; left: 10px; width: 350px; bottom: 100px;
            background: rgba(0, 15, 25, 0.95); border: 1px solid #00aa88;
            padding: 10px; display: none; font-family: 'Courier New', monospace;
            box-shadow: 0 0 25px rgba(0, 255, 204, 0.15);
            backdrop-filter: blur(8px); pointer-events: auto;
            overflow-y: auto; z-index: 20;
        }
        #topic-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #005544; padding-bottom: 8px; margin-bottom: 10px; }
        #topic-title { margin: 0; color: #fff; font-size: 20px; text-transform: uppercase; }
        #btn-close-topic { background: none; border: 1px solid #555; color: #888; cursor: pointer; padding: 2px 8px; }
        #btn-close-topic:hover { color: #fff; border-color: #fff; }

        .packet-item { border-bottom: 1px solid #224444; padding: 8px 0; font-size: 11px; }
        .packet-header { display: flex; justify-content: space-between; cursor: pointer; color: #aaa; }
        .packet-header:hover { color: #00ffcc; }
        .packet-domain { font-weight: bold; color: #00ddbb; }
        .packet-time { color: #666; }
        .packet-body { display: none; margin-top: 5px; color: #ddd; background: rgba(0,0,0,0.3); padding: 5px; white-space: pre-wrap; word-break: break-word; }
        .packet-item.expanded .packet-body { display: block; }

        #inspector-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 10px; }
        #inspector h2 { margin: 0; color: #fff; font-size: 18px; }
        #btn-minimize { background: none; border: none; color: #00ffcc; cursor: pointer; font-weight: bold; }
        
        .section-title { color: #fff; font-size: 14px; margin-top: 15px; border-bottom: 1px dotted #555; }
        #pie-chart { margin: 10px auto; display: block; }
        .token-list { font-size: 10px; color: #aaa; margin-top: 5px; }
        .token-item { display: flex; justify-content: space-between; }
        .sample-text { font-size: 10px; color: #888; font-style: italic; margin-top: 5px; border-left: 2px solid #00ffcc; padding-left: 5px; }
        .stat-row { display: flex; justify-content: space-between; margin: 5px 0; color: #aaa; font-size: 12px; }
        .stat-value { color: #00ffcc; font-weight: bold; }
        .grade-A { color: #0f0; } .grade-F { color: #f00; }
        
        #controls {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: auto;
        }
        .btn {
            background: rgba(0, 0, 0, 0.8); border: 1px solid #00ffcc; color: #00ffcc;
            padding: 5px 15px; cursor: pointer; font-family: monospace;
            transition: all 0.2s;
        }
        .btn:hover { background: #00ffcc; color: #000; }
        .btn.active { background: #00ffcc; color: #000; box-shadow: 0 0 10px #00ffcc; }

        /* Fingerprint Bars */
        .finger-row { display: flex; align-items: center; margin: 3px 0; font-size: 10px; }
        .finger-label { width: 70px; color: #888; }
        .finger-bar-bg { flex-grow: 1; background: #112233; height: 6px; position: relative; border-radius: 2px; overflow:hidden;}
        .finger-bar-fill { height: 100%; background: #00ffcc; transition: width 0.3s; }
        .finger-bar-fill.high-dev { background: #ff4444; } /* Red for high deviation */
        .finger-val { width: 30px; text-align: right; color: #fff; margin-left: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="hud-item">UNIVERSAL NETWORK MIRROR SOTA</div>
        <div class="hud-item" id="stats">FPS: 60 | PARTICLES: 0</div>
        <div class="hud-item" id="time-offset">DELAY: -500ms</div>
    </div>

    <div id="controls">
        <button class="btn" id="btn-pause">PAUSE</button>
        <button class="btn active" id="btn-live">LIVE</button>
        <div style="width: 20px"></div>
        <button class="btn active" id="btn-mode-traffic">TRAFFIC</button>
        <button class="btn" id="btn-mode-linguistic">LINGUISTIC</button>
        <div style="width: 20px"></div>
        <button class="btn" id="btn-blackhole-list" style="border-color: #ff4444; color: #ff4444;">BLACK HOLES</button>
        <button class="btn active" id="btn-toggle-void" style="border-color: #ff4444; color: #ff4444; font-size: 10px;">SHOW VOID</button>
    </div>

    <div id="blackhole-inspector" style="position: absolute; top: 60px; left: 10px; width: 300px; bottom: 100px; background: rgba(20, 0, 0, 0.95); border: 1px solid #ff4444; padding: 10px; display: none; font-family: 'Courier New', monospace; box-shadow: 0 0 25px rgba(255, 68, 68, 0.15); backdrop-filter: blur(8px); pointer-events: auto; overflow-y: auto; z-index: 20;">
        <div id="blackhole-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #550000; padding-bottom: 8px; margin-bottom: 10px;">
            <h2 style="margin: 0; color: #ff4444; font-size: 18px;">EVENT HORIZON</h2>
            <button id="btn-close-bh" style="background: none; border: 1px solid #844; color: #f88; cursor: pointer; padding: 2px 8px;">CLOSE</button>
        </div>
        <div id="blackhole-list"></div>
    </div>

    <div id="topic-inspector">
        <div id="topic-header">
            <h2 id="topic-title">TOPIC</h2>
            <button id="btn-close-topic">CLOSE</button>
        </div>
        <div id="topic-list"></div>
    </div>

    <div id="inspector">
        <div id="inspector-header">
            <h2 id="insp-name">DOMAIN</h2>
            <button id="btn-minimize">_</button>
        </div>
        
        <div id="inspector-body">
            <button id="btn-black-hole" class="btn" style="width: 100%; margin-bottom: 10px; border-color: #ff4444; color: #ff4444; display: none;">BLACK HOLE</button>

            <div class="stat-row"><span>TYPE</span><span class="stat-value" id="insp-type">PLANET</span></div>
            <div class="stat-row"><span>MASS</span><span class="stat-value" id="insp-mass">0</span></div>
            <div class="stat-row"><span>BLOAT SCORE</span><span class="stat-value" id="insp-bloat">0</span></div>
            <div class="stat-row"><span>RATING</span><span class="stat-value" id="insp-grade">A</span></div>
            
            <button id="btn-snapshot" class="btn" style="width: 100%; margin: 10px 0; border-color: #00ffcc; color: #00ffcc;">TAKE SNAPSHOT</button>

            <div class="section-title">HISTORY SNAPSHOTS</div>
            <div id="insp-snapshots" class="token-list" style="max-height: 100px; overflow-y: auto;"></div>
            <div id="insp-comparison" style="display: none; background: rgba(0, 50, 50, 0.8); padding: 5px; margin-top: 5px; border: 1px solid #00ffcc;"></div>

            <div class="section-title">FINGERPRINT SIGNATURE</div>
            <div id="insp-fingerprint">
                <!-- Bars injected by JS -->
            </div>

            <div class="section-title">PACKET STATS SAMPLING</div>
            <div style="display: flex; justify-content: space-around; margin: 10px 0;">
                <div style="text-align:center">
                    <div style="font-size:10px; color:#aaa; margin-bottom:2px">COUNT</div>
                    <canvas id="pie-chart-count" width="100" height="100"></canvas>
                </div>
                <div style="text-align:center">
                    <div style="font-size:10px; color:#aaa; margin-bottom:2px">SIZE</div>
                    <canvas id="pie-chart-size" width="100" height="100"></canvas>
                </div>
            </div>
            <div class="stat-row"><span>INTERNAL REQ</span><span class="stat-value" id="insp-internal">0 pkts / 0 KB</span></div>
            <div class="stat-row"><span>EXTERNAL RES</span><span class="stat-value" id="insp-external">0 pkts / 0 KB</span></div>

            <div class="section-title">TOP 10 DISTINCT TOKENS</div>
            <div id="insp-tokens" class="token-list"></div>

            <div class="section-title">SAMPLE OF PACKET</div>
            <div id="insp-sample" class="sample-text"></div>
        </div>
    </div>

    <canvas id="canvas"></canvas>
    <!-- Test Instrumentation Hook -->
    <script>
    (function () {
      window.__UNM_TEST_BUFFER__ = [];
      window.addEventListener('message', (ev) => {
        if (!ev.data || ev.data.type !== 'DEV_PROJECTION_TICK') return;
        window.__UNM_TEST_BUFFER__.push(ev.data.tick);
      });
      // Optional Profiling Hook
      window.__UNM_PROF = {
        events: [],
        mark(label) { this.events.push({ label, t: performance.now() }); }
      };
    })();
    </script>
    <script type="module" src="viewer.js"></script>
</body>
</html>
